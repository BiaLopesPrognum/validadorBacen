name: Monitorar Troca de Versão do Validador

on:
  schedule:
    # Executa todo dia às 8h (horário UTC → 5h no Brasil aprox)
    - cron: "0 8 * * *"
  workflow_dispatch:

jobs:
  check-validator:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
      - name: Checkout do repositório
        uses: actions/checkout@v4

      - name: Instalar Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Criar script de verificação
        run: |
          echo "import requests, ipaddress, socket, os, smtplib
from email.mime.text import MIMEText

VALIDADOR_URL = os.getenv('VALIDADOR_URL')
VERSION_FILE = 'ultima_versao.txt'
SMTP_SERVER = os.getenv('SMTP_SERVER')
SMTP_PORT = int(os.getenv('SMTP_PORT', '587'))
SMTP_USER = os.getenv('SMTP_USER')
SMTP_PASS = os.getenv('SMTP_PASS')
EMAIL_TO = os.getenv('EMAIL_TO')

# Função para detectar se o host é interno
def is_private(host):
    try:
        ip = socket.gethostbyname(host)
        return ipaddress.ip_address(ip).is_private
    except Exception:
        return False

def get_version():
    try:
        response = requests.get(VALIDADOR_URL, timeout=10)
        response.raise_for_status()
        return response.text.strip()
    except Exception as e:
        print(f'Erro ao obter versão: {e}')
        return None

def send_email(new_version):
    msg = MIMEText(f'Houve uma alteração na versão do validador: {new_version}')
    msg['Subject'] = 'Alteração na versão do Validador'
    msg['From'] = SMTP_USER
    msg['To'] = EMAIL_TO

    with smtplib.SMTP(SMTP_SERVER, SMTP_PORT) as server:
        server.starttls()
        server.login(SMTP_USER, SMTP_PASS)
        server.send_message(msg)
        print('E-mail enviado com sucesso!')

def main():
    host = VALIDADOR_URL.split('/')[2]
    if is_private(host):
        print(f'{host} é um IP interno.')
    else:
        print(f'{host} é um IP externo.')

    new_version = get_version()
    if not new_version:
        return

    old_version = ''
    if os.path.exists(VERSION_FILE):
        with open(VERSION_FILE, 'r') as f:
            old_version = f.read().strip()

    if new_version != old_version:
        print(f'Nova versão detectada: {new_version}')
        with open(VERSION_FILE, 'w') as f:
            f.write(new_version)
        send_email(new_version)
    else:
        print('Nenhuma alteração detectada.')

if __name__ == '__main__':
    main()
" > monitor_validador.py

      - name: Executar script
        env:
          VALIDADOR_URL: ${{ secrets.VALIDADOR_URL }}
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
        run: python monitor_validador.py
