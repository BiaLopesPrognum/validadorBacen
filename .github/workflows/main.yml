name: Check Validador Version

on:
  schedule:
    - cron: "0 * * * *"  # Executa a cada hora
  workflow_dispatch:     # Permite rodar manualmente pelo botÃ£o "Run workflow"

permissions:
  contents: write  # Permite commit automÃ¡tico

jobs:
  check_version:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install curl and grep
        run: sudo apt-get update && sudo apt-get install -y curl grep

      - name: Get current version from site
        id: get_version
        run: |
          PAGE=$(curl -s https://www.bcb.gov.br/api/paginasite/sitebcb/estabilidadefinanceira/scrdoc3040)
          VERSION=$(echo "$PAGE" | grep -oE 'Release[[:space:]]+[0-9]+' | head -1 | awk '{print $2}')
          
          if [ -z "$VERSION" ]; then
            echo "âš ï¸ Nenhuma versÃ£o encontrada na pÃ¡gina!"
            VERSION="erro"
          fi

          echo "VersÃ£o atual encontrada: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Compare with last stored version
        id: compare
        run: |
          FILE="ultima_versao.txt"
          if [ -f "$FILE" ]; then
            LAST=$(cat "$FILE")
          else
            LAST="none"
          fi

          echo "Ãšltima versÃ£o registrada: $LAST"
          echo "Nova versÃ£o: ${{ steps.get_version.outputs.version }}"

          if [ "$LAST" != "${{ steps.get_version.outputs.version }}" ]; then
            echo "Nova versÃ£o detectada!"
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "last_version=$LAST" >> $GITHUB_OUTPUT
            echo "${{ steps.get_version.outputs.version }}" > "$FILE"
          else
            echo "Nenhuma mudanÃ§a detectada."
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "last_version=$LAST" >> $GITHUB_OUTPUT
          fi

      - name: Commit new version (if changed)
        if: steps.compare.outputs.changed == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add ultima_versao.txt
          git commit -m "Atualiza versÃ£o do Validador para ${{ steps.get_version.outputs.version }}"
          git push

      - name: Notificar no Google Chat (nova versÃ£o detectada)
        if: always()
        run: |
          curl -X POST \
            -H 'Content-Type: application/json' \
            -d "{
              \"cardsV2\": [
                {
                  \"cardId\": \"validador-update\",
                  \"card\": {
                    \"header\": {
                      \"title\": \"ðŸš€ Nova versÃ£o do Validador detectada!\",
                      \"subtitle\": \"Workflow: Check Validador Version\",
                      \"imageUrl\": \"https://cdn-icons-png.flaticon.com/512/5610/5610944.png\",
                      \"imageType\": \"CIRCLE\"
                    },
                    \"sections\": [
                      {
                        \"header\": \"ðŸ“¦ Detalhes da atualizaÃ§Ã£o\",
                        \"widgets\": [
                          {
                            \"decoratedText\": {
                              \"topLabel\": \"VersÃ£o anterior\",
                              \"text\": \"${{ steps.compare.outputs.last_version }}\"
                            }
                          },
                          {
                            \"decoratedText\": {
                              \"topLabel\": \"Nova versÃ£o\",
                              \"text\": \"${{ steps.get_version.outputs.version }}\"
                            }
                          },
                          {
                            \"decoratedText\": {
                              \"topLabel\": \"RepositÃ³rio\",
                              \"text\": \"${{ github.repository }}\"
                            }
                          }
                        ]
                      },
                      {
                        \"header\": \"ðŸ”— AÃ§Ãµes\",
                        \"widgets\": [
                          {
                            \"buttonList\": {
                              \"buttons\": [
                                {
                                  \"text\": \"Ver workflow no GitHub\",
                                  \"onClick\": {
                                    \"openLink\": {
                                      \"url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
                                    }
                                  }
                                },
                                {
                                  \"text\": \"Ver repositÃ³rio\",
                                  \"onClick\": {
                                    \"openLink\": {
                                      \"url\": \"${{ github.server_url }}/${{ github.repository }}\"
                                    }
                                  }
                                }
                              ]
                            }
                          }
                        ]
                      }
                    ]
                  }
                }
              ]
            }" \
            ${{ secrets.GOOGLE_CHAT_WEBHOOK }}
